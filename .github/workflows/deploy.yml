name: Deploy
on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    deploy:
        name: "Deploy to VPS"
        runs-on: ubuntu-latest
        steps:
            - name: Configure SSH
              run: |
                mkdir -p ~/.ssh/
                echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy-key.pem
                chmod 600 ~/.ssh/deploy-key.pem
                cat >> ~/.ssh/config <<END
                Host my-vps
                    HostName $SSH_IP
                    User $SSH_USER
                    IdentityFile ~/.ssh/deploy-key.pem
                    StrictHostKeyChecking no
                END
              env:
                SSH_USER:  ${{ secrets.SSH_USER }}
                SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                SSH_IP: ${{ secrets.SSH_IP }}
            - name: Redeploy on VPS
              run: |
                ssh my-vps << 'EOF'
                cd ~/mlhportfolio 
                chmod +x ./scripts/redeploy.sh
                ./scripts/redeploy.sh
                docker ps -f 'name=mysql' -f 'name=myport' -f 'name=nginx'
                EOF
            - name: Send Notification
              run: |
                curl -s -X POST "$DISCORD_WEBHOOK" -H "Content-Type:application/json" \
                -d '{
                  "embeds": [{
                    "Title": "Port Deployment",
                    "Desc": "Docker Container deployed",
                    "footer": {"text": "Origin: Github"}
                    }]
                }'
              env:
                DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
